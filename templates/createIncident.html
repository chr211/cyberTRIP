<!DOCTYPE html>
<html>
<head>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<meta charset="UTF-8">
    <title>Incident App</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/main.css') }}">
</head>
<body>

    <button id="back_button" onclick="location.href='/dashboard'">Back To Dashboard</button>

    <!--API SECTION -->
    <div style="border: 1px solid black; padding: 10px; margin-bottom: 20px;">
        <h2>URL Scan</h2>
        <input type="text" id="url" placeholder="Enter URL">
        <button id="urlscanButton">urlscan.io</button>
        <pre id="urlscanResult" style="background-color: #f8f8f8; padding: 10px;">Results will appear here.</pre>
        <div id="resultLinkContainer"></div>
    </div>

    <form action="/submit" method="post">
        <div id="formContainer">
            <div class="inputContainer">
                <label for="incident_number">Incident Number:</label>
                <input type="text" id="incident_number" name="incident_number">
            </div>

            <div class="inputContainer">
                <label for="severity">Severity:</label>
                <select id="severity" name="severity">
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                    <option value="severe">Severe</option>
                    <option value="emergency">Emergency</option>
                </select>
            </div>

            <div class="inputContainer">
                <label for="date">Date:</label>
                <input type="text" id="date" name="date">
            </div>

            <div class="inputContainer">
                <label for="analyst_name">Analyst Name:</label>
                <input type="text" id="analyst_name" name="analyst_name">
            </div>

            <div class="inputContainer">
                <label for="incident_type">Incident Type:</label>
                <select id="incident_type" name="incident_type">
                    <option value="phish">Phish</option>
                    <option value="DDos">DDos</option>
                    <option value="Other Security">Other Security</option>
                </select>
            </div>

            <div class="inputContainer">
                <label for="email_address">Email Address:</label>
                <input type="text" id="email_address" name="email_address">
            </div>

            <div class="inputContainer">
                <label for="subject_line">Subject Line:</label>
                <input type="text" id="subject_line" name="subject_line">
            </div>

            <div class="inputContainer">
                <label for="emails_sent">Emails Sent:</label>
                <input type="text" id="emails_sent" name="emails_sent">
            </div>

            <div class="inputContainer">
                <label for="replies">Replies:</label>
                <input type="text" id="replies" name="replies">
            </div>

	    <div class="inputContainer">
    		<label for="urls">Urls:</label>
    	    	<input type="text" id="urls" name="urls">
	    </div>

            <div class="inputContainer">
                <label for="notes">Notes:</label>
                <textarea id="notes" name="notes"></textarea>
            </div>

            <input type="submit" value="Submit">
        </div>
    </form>

    <!--buttons-->
    <input type="text" id="newSearchInput" placeholder="Enter search query">
    <button id="newSearchButton">Search Database</button>
    <button onclick="location.href='/load-from-mongo'">Load Data from MongoDB</button>
    <button onclick="location.href='/export-to-csv'">Export to CSV</button>
    <button onclick="location.href='/clear-data'">Clear Data</button>

    <BR>
    <!-- Only show create user if current user is admin-->
    {% if session['user_type'] == 'superuser' %}
    <button onclick="location.href='/create-user'">Create New User</button>
    {% endif %}

    <!-- Logout Button -->
    <button id="logoutButton">Logout</button>

    <!-- Script for logout functionality -->
    <script>
    document.getElementById("logoutButton").addEventListener("click", function() {
        let saveData = confirm("Would you like to save the current table data to the database?");
        
        fetch("/logout", {
            method: "POST",
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `save_data=${saveData ? "yes" : "no"}`,  // Send user's choice to server
        })
        .then(() => {
            window.location.href = "/login";  // Redirect to login page after logging out
        });
    });
    </script>

	<button type="button" id="deleteRecordButton">Delete Selected Records</button>


    <!-- Display data here below everything. headings first-->
    <table id="data-display">
        <tr>
	    <th>Select</th>
            <th>Incident Number</th>
            <th>Severity</th>
            <th>Date</th>
            <th>Analyst Name</th>
            <th>Incident Type</th>
            <th>Email Address</th>
            <th>Subject Line</th>
	    <th>Urls</th>
            <th>Notes</th>
            <th>Emails Sent</th>
            <th>Replies</th>
        </tr>
        

<script>
document.addEventListener('DOMContentLoaded', function() {
    // This function handles clicks on URL links in the table.
    function handleUrlClick(e) {
        e.preventDefault();  // Stop the browser from following the link

        // 'currentTarget' refers to the element to which the event listener is attached
        // as opposed to 'target' which indicates the element that was actually clicked
        const url = e.currentTarget.getAttribute('data-url'); 

       
        fetch(`/urlscan?url=${url}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById("urlscanResult").innerText = JSON.stringify(data, null, 2);
                if (data.result) {
                    let linkContainer = document.getElementById("resultLinkContainer");
                    linkContainer.innerHTML = `<a href="${data.result}" target="_blank">View Scan Result</a>`;
                }
            })
            .catch(error => {
                console.error("Error:", error);
                document.getElementById("urlscanResult").innerText = "Error fetching data!";
            });
    }

    // Attach the above function as an event listener to each link in the 'URLs' column
    document.querySelectorAll('.url-link').forEach(linkElement => {
        linkElement.addEventListener('click', handleUrlClick);
    });
});
</script>




{% for item in data_list %}
<tr data-id="{{ item._id }}">
    <td><input type="checkbox" id="recordCheckbox-{{ item._id }}" name="recordSelection" class="recordCheckbox"></td>
    <td>{{ item.incident_number }}</td>
    <td>{{ item.severity }}</td>
    <td>{{ item.date }}</td>
    <td>{{ item.analyst_name }}</td>
    <td>{{ item.incident_type }}</td>
    <td>{{ item.email_address }}</td>
    <td>{{ item.subject_line }}</td>
    <td>
        {% if item.urls %}
            <!-- Split the URLs string by comma and create a link for each URL -->
            {% set urls_list = item.urls.split(',') %}
            {% for url in urls_list %}
                <a href="#" class="url-link" data-url="{{ url.strip() }}" style="display: block;">{{ url.strip() }}</a>
            {% endfor %}

	{% else %}
            <!-- If there's no URL, display a default text or leave it empty -->
            N/A
        {% endif %}
    </td>
    <td class="notes">{{ item.notes|safe }}</td>
    <td>{{ item.emails_sent }}</td>
    <td>{{ item.replies }}</td>
</tr>
{% endfor %}


	
    
    


       
            
    </table>

    <!-- <hr style="border-top: 5px solid black;"> -->

    


    <!--hello javascript section , first part if for the urlscan api button and display-->
    <script>
    //event listener setup for urlscan button click
    document.getElementById("urlscanButton").addEventListener("click", function() {
        let url = document.getElementById("url").value;//url to post to urlscan.io
        //This contacts the /urlscan app route to get the urlscan info
        fetch(`/urlscan?url=${url}`)
            .then(response => response.json())
            .then(data => {
                // Convert the JSON data to a formatted string and display it inside an element with the id "urlscanResult"
                document.getElementById("urlscanResult").innerText = JSON.stringify(data, null, 2);
    
        // If the returned JSON data has a "result" property, display a clickable link to view the scan result.    
        if (data.result) {
                    let linkContainer = document.getElementById("resultLinkContainer");
                    linkContainer.innerHTML = `<a href="${data.result}" target="_blank">View Scan Result</a>`;
                }
            })
            .catch(error => {
                console.error("Error:", error);
                document.getElementById("urlscanResult").innerText = "Error fetching data!";
            });
    });
</script>
    <script>
        document.getElementById("newSearchButton").addEventListener("click", function() {
            var query = document.getElementById("newSearchInput").value;

            fetch("/search-database", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `query=${query}`
            })
            .then(response => response.json())
            .then(data => {
                // Get the main data-display table and clear it
                let table = document.getElementById("data-display");
                while (table.rows.length > 1) {  // Keep the header row
                    table.deleteRow(1);
                }

                // Populate data rows for the search results
            data.forEach(item => {
                let row = table.insertRow();
		row.setAttribute('data-id', item._id);  // <-- Make sure to set this attribute
    		

                row.insertCell(0).innerHTML = '<input type="checkbox" class="recordCheckbox">'; // for the checkbox

                // Explicitly set each cell's content to match the correct property from the data
                row.insertCell(1).textContent = item.incident_number || ''; // || '' ensures that if the value is undefined, it defaults to an empty string
                row.insertCell(2).textContent = item.severity || '';
                row.insertCell(3).textContent = item.date || '';
                row.insertCell(4).textContent = item.analyst_name || '';
                row.insertCell(5).textContent = item.incident_type || '';
                row.insertCell(6).textContent = item.email_address || '';
                row.insertCell(7).textContent = item.subject_line || '';
		row.insertCell(8).textContent = item.urls || '';
                row.insertCell(9).textContent = item.notes || '';
                row.insertCell(10).textContent = item.emails_sent || '';
                row.insertCell(11).textContent = item.replies || '';
            });
        });
    });
</script>



    </script>

<script>
// Wait for the entire content of the window to be loaded
window.addEventListener('DOMContentLoaded', (event) => {

    // Select the form
    const form = document.querySelector('form');

    // Listen for form submission
    form.addEventListener('submit', async function (e) {
        e.preventDefault(); // Prevents the default form submission

        // Use FormData to retrieve the values entered in the form
        const formData = new FormData(form);
	formData.append('urls', document.getElementById('urls').value);

        try {
            // Send the form data to the server using fetch()
            const response = await fetch('/submit', {
                method: 'POST',
                body: formData,
            });

            // Check if the response is successful
            if (response.ok) {		
		// First, check the response text to understand what is being received
            	const responseText = await response.text();
            	console.log('Server response:', responseText);	

                // Then, if we're sure it's JSON, we can parse it
            	const data = JSON.parse(responseText);

                // Get the table where the data will be displayed
                const displayTable = document.getElementById('data-display');

                // Create a new row and fill it with data
                const newRow = displayTable.insertRow(-1); // -1 means the new row will be inserted at the last position

		// Insert a new cell for the checkbox and set its content
    		const checkboxCell = newRow.insertCell(0);
   		checkboxCell.innerHTML = '<input type="checkbox" class="recordCheckbox">';


                // Assuming the server responds with the same object keys as the form's names
                // Insert cells and content
                const cell1 = newRow.insertCell(1);
                cell1.textContent = data.incident_number;

                const cell2 = newRow.insertCell(2);
                cell2.textContent = data.severity;

                // Extract the date string from the date object and optionally format it
		const dateString = data.date.$date;
		const formattedDate = new Date(dateString).toLocaleDateString("en-US");
                
		const cell3 = newRow.insertCell(3);
                cell3.textContent = formattedDate;

                const cell4 = newRow.insertCell(4);
                cell4.textContent = data.analyst_name;

                const cell5 = newRow.insertCell(5);
                cell5.textContent = data.incident_type;

                const cell6 = newRow.insertCell(6);
		cell6.textContent = data.email_address;

		const cell7 = newRow.insertCell(7);
		cell7.textContent = data.subject_line;

		const cell8 = newRow.insertCell(8);
		cell8.textContent = data.urls;

		const cell9 = newRow.insertCell(9);
		cell9.textContent = data.notes;

		const cell10 = newRow.insertCell(10);
		cell10.textContent = data.emails_sent;

		const cell11 = newRow.insertCell(11);
		cell11.textContent = data.replies;

            } else {
                throw new Error(`Submission failed with status code: ${response.status}`);
            }
        } catch (error) {
            console.error('Error:', error);
            // Optionally: display a message to the user about the failure
        }
    });
});
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {

	

        // Getting the delete button element
        const deleteRecordButton = document.getElementById("deleteRecordButton");

        // Adding click event listener to the delete button
        deleteRecordButton.addEventListener("click", function() {
            // Array to hold the IDs of the records to delete
            let idsToDelete = [];

            // Gathering all checked records
            document.querySelectorAll('.recordCheckbox:checked').forEach(checkbox => {
                let recordId = checkbox.closest('tr').getAttribute('data-id');
                idsToDelete.push(recordId);
            });

            // Check if any records were selected
            if (idsToDelete.length === 0) {
                alert('No records selected for deletion.');
                return;
            }

            // Confirm with the user
            let confirmation = confirm('Are you sure you want to delete the selected records?');
            if (!confirmation) {
                return;
            }

            // Create an asynchronous function for the fetch operation
            async function deleteRecords() {
                try {
                    // Send a request to the server to delete records with these IDs
                    let response = await fetch('/delete-incidents', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ ids: idsToDelete }) // send the IDs as JSON
                    });

                    // Convert the response to JSON
                    let result = await response.json();

                    if (response.ok) {
                        alert('Records deleted successfully.');

                        // If successful, remove the rows from the table
                        idsToDelete.forEach(id => {
                            let row = document.querySelector(`tr[data-id="${id}"]`);
                            if (row) {
                                row.remove();
                            }
                        });
                    } else {
                        // If there was a problem with the deletion process
                        let message = result.message || 'Error deleting records.';
                        alert(message);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred while deleting records.');
                }
            }

            // Call the asynchronous function
            deleteRecords();
        });
    });
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Regular expression to detect URLs
    const urlRegex = /(https?:\/\/[^\s]+)/g;

    // Process each 'notes' cell in the table
    document.querySelectorAll('.notes').forEach(cell => {
        // Replace URLs in the text with clickable links
        cell.innerHTML = cell.textContent.replace(urlRegex, '<a href="$1" class="urlscan-link">$1</a>');
    });

    // Add a click event listener to each link
    document.querySelectorAll('.urlscan-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();  // Prevent the default click behavior
            let url = e.target.href;

            // Fetch the URL scan results
            fetch(`/urlscan?url=${url}`)
                .then(response => response.json())
                .then(data => {
                    // Display the results in the 'resultLinkContainer'
                    document.getElementById("urlscanResult").innerText = JSON.stringify(data, null, 2);

                    // Display a clickable link if there's a 'result' property in the returned data
                    if (data.result) {
                        let linkContainer = document.getElementById("resultLinkContainer");
                        linkContainer.innerHTML = `<a href="${data.result}" target="_blank">View Scan Result</a>`;
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    document.getElementById("urlscanResult").innerText = "Error fetching data!";
                });
        });
    });
});

</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // This function handles clicks on URL links in the table.
    function handleUrlClick(e) {
        e.preventDefault();  // Stop the browser from following the link

        // 'currentTarget' refers to the element to which the event listener is attached
        // as opposed to 'target' which indicates the element that was actually clicked
        const url = e.currentTarget.getAttribute('data-url'); 

        // Continue with the existing fetch logic using the extracted URL
        fetch(`/urlscan?url=${url}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById("urlscanResult").innerText = JSON.stringify(data, null, 2);
                if (data.result) {
                    let linkContainer = document.getElementById("resultLinkContainer");
                    linkContainer.innerHTML = `<a href="${data.result}" target="_blank">View Scan Result</a>`;
                }
            })
            .catch(error => {
                console.error("Error:", error);
                document.getElementById("urlscanResult").innerText = "Error fetching data!";
            });
    }

    // Attach the above function as an event listener to each link in the 'URLs' column
    document.querySelectorAll('.url-link').forEach(linkElement => {
        linkElement.addEventListener('click', handleUrlClick);
    });
});
</script>



</body>
</html>
